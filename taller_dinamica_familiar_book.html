<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taller de Dinámica Familiar - Libro Interactivo (Uso Local)</title>
    <!-- Iconos de Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fuente: Lato y Merriweather -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    <style>
        /* La dependencia de Font Awesome y Google Fonts requiere una conexión temporal para cargar los estilos. 
           Si planeas usarlo completamente offline, estas líneas deben ser eliminadas o reemplazadas por versiones descargadas.
           Para la mayoría de los casos de uso local, cargarán la primera vez y permanecerán en caché. */
        :root {
            --primary: #2c5282; /* Azul profundo */
            --secondary: #ed8936; /* Naranja cálido */
            --bg-body: #f7fafc;
            --bg-book: #ffffff;
            --text-main: #2d3748;
            --border: #e2e8f0;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR DE NAVEGACIÓN --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #1a365d;
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            background: #152c4b;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
            margin: 0;
            font-family: 'Merriweather', serif;
        }

        .chapter-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }

        .chapter-item {
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .chapter-btn {
            width: 100%;
            text-align: left;
            padding: 15px 20px;
            background: none;
            border: none;
            color: #cbd5e0;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .chapter-btn:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .chapter-btn.active {
            background: var(--secondary);
            color: white;
            font-weight: bold;
            border-left: 4px solid white;
        }

        .chapter-btn i { margin-right: 10px; width: 20px; text-align: center; }

        /* --- CONTENIDO PRINCIPAL --- */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 40px;
            scroll-behavior: smooth;
        }

        .book-page {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-book);
            padding: 50px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: none; /* Se ocultan por defecto */
            animation: fadeIn 0.4s ease;
        }

        .book-page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 { color: var(--primary); border-bottom: 2px solid var(--secondary); padding-bottom: 10px; margin-top: 0; font-family: 'Merriweather', serif; }
        h3 { color: #4a5568; margin-top: 30px; font-family: 'Merriweather', serif; font-size: 1.2rem; }
        p { line-height: 1.6; font-size: 1.05rem; }

        /* --- COMPONENTES INTERACTIVOS --- */
        
        /* Inputs */
        .interactive-box {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        label { display: block; font-weight: bold; margin-bottom: 8px; color: var(--primary); }
        
        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
        }

        /* Drag and Drop */
        .drag-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .drop-zone {
            background: #edf2f7;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 15px;
            min-height: 150px;
        }

        .drop-zone h4 { margin-top: 0; color: var(--primary); text-align: center; }

        .draggable {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            cursor: move;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }

        .draggable:active { cursor: grabbing; }

        /* Multiple Choice */
        .mc-option {
            display: block;
            width: 100%;
            text-align: left;
            padding: 12px 15px;
            margin-bottom: 8px;
            border: 1px solid #cbd5e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mc-option:hover { background: #ebf8ff; border-color: var(--primary); }
        .mc-option.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* Accordion */
        details {
            margin-bottom: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        summary {
            background: #f7fafc;
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            color: var(--primary);
            list-style: none;
        }
        
        summary::-webkit-details-marker { display: none; }
        summary::after { content: '+'; float: right; font-weight: bold; }
        details[open] summary::after { content: '-'; }

        .details-content { padding: 15px; background: white; border-top: 1px solid var(--border); }

        /* Navegación Inferior */
        .nav-footer {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }

        .nav-btn {
            background: white;
            border: 1px solid #cbd5e0;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            color: var(--text-main);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover { background: #f7fafc; }
        .nav-btn.primary { background: var(--secondary); color: white; border-color: var(--secondary); }
        .nav-btn.primary:hover { background: #dd6b20; }

        /* Utility */
        .feedback-msg {
            margin-top: 10px;
            padding: 10px;
            background: #f0fff4;
            color: #2f855a;
            border-radius: 6px;
            display: none;
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 60px; overflow: hidden; }
            .sidebar.expanded { max-height: 50vh; }
            .main-content { padding: 20px; }
            .book-page { padding: 25px; }
            .drag-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Sidebar Navegación -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header" onclick="toggleSidebar()">
            <h1><i class="fa-solid fa-book-open"></i> Dinámica Familiar</h1>
        </div>
        <ul class="chapter-list">
            <li><button class="chapter-btn active" onclick="goToPage(1)"><i class="fa-solid fa-door-open"></i> 1. Bienvenida</button></li>
            <li><button class="chapter-btn" onclick="goToPage(2)"><i class="fa-solid fa-heart"></i> 2. Virtudes</button></li>
            <li><button class="chapter-btn" onclick="goToPage(3)"><i class="fa-solid fa-magnifying-glass"></i> 3. Conducta</button></li>
            <li><button class="chapter-btn" onclick="goToPage(4)"><i class="fa-solid fa-shield-halved"></i> 4. Prevención</button></li>
            <li><button class="chapter-btn" onclick="goToPage(5)"><i class="fa-solid fa-list-check"></i> 5. Plan de Acción</button></li>
            <li><button class="chapter-btn" onclick="goToPage(6)"><i class="fa-solid fa-burger"></i> 6. Sándwich</button></li>
            <li><button class="chapter-btn" onclick="goToPage(7)"><i class="fa-solid fa-flag"></i> 7. Resumen</button></li>
        </ul>
    </nav>

    <!-- Contenido Principal -->
    <main class="main-content">
        
        <!-- PÁGINA 1: Bienvenida -->
        <div class="book-page active" id="page-1">
            <h2>Capítulo 1: Bienvenida y Objetivo</h2>
            <div style="text-align: center; margin-bottom: 30px;">
                <img src="https://images.unsplash.com/photo-1542037104857-ffbb0b9155fb?auto=format&fit=crop&w=600&q=80" alt="Familia feliz" style="max-width: 100%; border-radius: 8px;" onerror="this.onerror=null;this.src='https://placehold.co/600x400/2c5282/ffffff?text=Imagen+de+Familia';">
            </div>
            <p><strong>Guía práctica: Virtudes, conducta y comunicación efectiva.</strong></p>
            <p>Este es un taller interactivo donde su honestidad y participación son la clave del cambio. Tómate tu tiempo.</p>
            
            <div class="interactive-box">
                <label for="p1-intencion"><i class="fa-solid fa-pen"></i> ¿Qué esperas mejorar hoy en tu familia?</label>
                <textarea id="p1-intencion" rows="3" placeholder="Escribe tu intención principal..."></textarea>
            </div>

            <div class="nav-footer">
                <span></span> <!-- Espaciador -->
                <button class="nav-btn primary" onclick="goToPage(2)">Siguiente <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- PÁGINA 2: Virtudes -->
        <div class="book-page" id="page-2">
            <h2>Capítulo 2: Virtudes Fundamentales</h2>
            <p>Identificar, Valorar, Escribir. Reconocer lo bueno es la base para mejorar lo difícil.</p>
            
            <div class="interactive-box">
                <label for="p2-virtudes"><i class="fa-solid fa-list"></i> Escribe 5 virtudes que valoras en tu familia:</label>
                <textarea id="p2-virtudes" rows="4" placeholder="1. Paciencia... 2. Humor..."></textarea>
            </div>

            <h3>Priorización de Virtudes</h3>
            <p>Arrastra las virtudes a la columna correspondiente:</p>
            
            <div class="drag-container">
                <div class="drop-zone" id="zone-presente" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4><i class="fa-solid fa-check"></i> Muy Presentes</h4>
                    <div class="draggable" draggable="true" ondragstart="drag(event)" id="drag1">Alegría</div>
                    <div class="draggable" draggable="true" ondragstart="drag(event)" id="drag2">Solidaridad</div>
                </div>
                <div class="drop-zone" id="zone-fortalecer" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4><i class="fa-solid fa-dumbbell"></i> Quiero Fortalecer</h4>
                    <div class="draggable" draggable="true" ondragstart="drag(event)" id="drag3">Paciencia</div>
                    <div class="draggable" draggable="true" ondragstart="drag(event)" id="drag4">Escucha Activa</div>
                    <div class="draggable" draggable="true" ondragstart="drag(event)" id="drag5">Orden</div>
                </div>
            </div>

            <div class="nav-footer">
                <button class="nav-btn" onclick="goToPage(1)"><i class="fa-solid fa-arrow-left"></i> Anterior</button>
                <button class="nav-btn primary" onclick="goToPage(3)">Siguiente <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- PÁGINA 3: Conducta -->
        <div class="book-page" id="page-3">
            <h2>Capítulo 3: Análisis de Conducta</h2>
            
            <h3>Mirando alrededor</h3>
            <p>¿Cuál de estos comportamientos afecta más la armonía actualmente?</p>
            <div id="mc-container">
                <button class="mc-option" onclick="selectOption(this, 'mc-feedback')">Gritos / Voz alta</button>
                <button class="mc-option" onclick="selectOption(this, 'mc-feedback')">Indiferencia / Ley del hielo</button>
                <button class="mc-option" onclick="selectOption(this, 'mc-feedback')">Desorden / Falta de cooperación</button>
                <button class="mc-option" onclick="selectOption(this, 'mc-feedback')">Otro</button>
            </div>
            <div id="mc-feedback" class="feedback-msg" style="display: none;">Gracias por tu honestidad; notar el patrón es el primer paso.</div>

            <h3>Mirándote a ti (Autoanálisis)</h3>
            <div class="interactive-box">
                <label>¿Qué hago cuando me siento frustrado/a?</label>
                <input type="text" id="p3-frustracion" placeholder="Ej: Me encierro, grito...">
                
                <label style="margin-top:15px;">¿Qué desearía hacer en su lugar?</label>
                <input type="text" id="p3-deseo" placeholder="Ej: Respirar profundo, pedir tiempo fuera...">
                
                <label style="margin-top:15px;">¿Qué ejemplo quiero modelar?</label>
                <input type="text" id="p3-modelo" placeholder="Ej: Calma bajo presión...">
            </div>

            <div class="interactive-box">
                <h3>La Tarea: Análisis Individual</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label>Persona 1</label>
                        <textarea id="p3-pers1" rows="3" placeholder="Conductas y efectos..."></textarea>
                    </div>
                    <div>
                        <label>Persona 2</label>
                        <textarea id="p3-pers2" rows="3" placeholder="Conductas y efectos..."></textarea>
                    </div>
                    <div>
                        <label>Yo</label>
                        <textarea id="p3-yo" rows="3" placeholder="Mis conductas y efectos..."></textarea>
                    </div>
                </div>
            </div>

            <div class="nav-footer">
                <button class="nav-btn" onclick="goToPage(2)"><i class="fa-solid fa-arrow-left"></i> Anterior</button>
                <button class="nav-btn primary" onclick="goToPage(4)">Siguiente <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- PÁGINA 4: Prevención -->
        <div class="book-page" id="page-4">
            <h2>Capítulo 4: Prevención Futura</h2>
            <blockquote style="background: #fff3cd; padding: 15px; border-left: 5px solid #ecc94b; font-style: italic; margin: 20px 0;">
                "Prevenir es mejor que reparar."
            </blockquote>

            <div class="interactive-box">
                <label for="p4-lineas"><i class="fa-solid fa-ban"></i> Líneas Rojas: Enumera 5 conductas que deseas prevenir</label>
                <p style="font-size: 0.9em; color: #718096;">Tip: Que sean observables y concretas.</p>
                <textarea id="p4-lineas" rows="5" placeholder="1. Insultar durante una discusión..."></textarea>
            </div>

            <div class="interactive-box" style="border-color: #4299e1;">
                <label><i class="fa-solid fa-question-circle"></i> Verdadero o Falso</label>
                <p>Una "línea roja" o límite debe ser abstracta y depender del humor del momento.</p>
                <div style="display: flex; gap: 10px;">
                    <!-- Sin calificación, solo feedback informativo -->
                    <button class="nav-btn" onclick="showFeedback('tf-feedback', 'Incorrecto. Los límites deben ser CLAROS y constantes.')">Verdadero</button>
                    <button class="nav-btn primary" onclick="showFeedback('tf-feedback', '¡Correcto! Las líneas rojas deben ser concretas y observables. Ser específico facilita pedir cambios y medir progreso.')">Falso</button>
                </div>
                <div id="tf-feedback" class="feedback-msg" style="display: none; background: #ebf8ff; color: #3182ce;"></div>
            </div>

            <div class="nav-footer">
                <button class="nav-btn" onclick="goToPage(3)"><i class="fa-solid fa-arrow-left"></i> Anterior</button>
                <button class="nav-btn primary" onclick="goToPage(5)">Siguiente <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- PÁGINA 5: Plan -->
        <div class="book-page" id="page-5">
            <h2>Capítulo 5: Plan de Acción y Guión</h2>
            
            <h3>Pasos Clave</h3>
            <details open>
                <summary>1. Diseñar</summary>
                <div class="details-content">Elige una conducta específica para tratar. No intentes arreglar todo en un día.</div>
            </details>
            <details>
                <summary>2. Guión</summary>
                <div class="details-content">Escribe exactamente qué dirás; sé claro, conciso y habla desde "Yo me siento..."</div>
            </details>
            <details>
                <summary>3. Ensayo</summary>
                <div class="details-content">Practica en voz alta o frente al espejo. Escucha tu tono de voz.</div>
            </details>
            <details>
                <summary>4. Ejecutar</summary>
                <div class="details-content">Busca el momento adecuado (sin hambre, sin prisa, sin sueño) para hablar.</div>
            </details>

            <div class="interactive-box">
                <label><i class="fa-solid fa-pencil-ruler"></i> Tu Guión</label>
                <p>Usa este espacio para redactar lo que dirás. Piensa en la estructura:</p>
                <textarea id="p5-guion" rows="6" placeholder="Apertura positiva:\n\nPetición concreta:\n\nCierre con confianza:"></textarea>
            </div>

            <div class="nav-footer">
                <button class="nav-btn" onclick="goToPage(4)"><i class="fa-solid fa-arrow-left"></i> Anterior</button>
                <button class="nav-btn primary" onclick="goToPage(6)">Siguiente <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- PÁGINA 6: Sandwich -->
        <div class="book-page" id="page-6">
            <h2>Capítulo 6: Estrategia del Sándwich</h2>
            <div style="display: flex; align-items: center; gap: 20px; background: #fffaf0; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <i class="fa-solid fa-burger" style="font-size: 3rem; color: var(--secondary);"></i>
                <p>Esta técnica suaviza la crítica colocándola entre dos comentarios positivos genuinos (Elogio - Petición - Elogio).</p>
            </div>

            <div class="interactive-box">
                <label>1. Pan Superior (Elogio)</label>
                <input type="text" id="p6-elogio" placeholder="Ej: Valoro mucho tu esfuerzo en la casa...">
                
                <label style="margin-top: 15px;">2. Relleno (La Petición / Crítica)</label>
                <input type="text" id="p6-peticion" placeholder="Ej: Sin embargo, cuando dejas la ropa tirada, me siento...">
                
                <label style="margin-top: 15px;">3. Pan Inferior (Cierre Positivo)</label>
                <input type="text" id="p6-cierre" placeholder="Ej: Sé que podemos mejorar esto juntos porque eres muy colaborador.">
            </div>

            <h3>Role-Play (Simulación de escenarios)</h3>
            <p>Anticipa las reacciones para mantener la calma:</p>
            <details>
                <summary>Si la persona se pone defensiva...</summary>
                <div class="details-content">Haz una pausa. Valida su emoción: "Entiendo que esto te molesta". **Camino:** Pausa y validar emoción.</div>
            </details>
            <details>
                <summary>Si no hay tiempo ahora...</summary>
                <div class="details-content">Reprograma: "Hablemos de esto después de la cena cuando estemos tranquilos". **Camino:** Reprogramar con mensaje afectuoso.</div>
            </details>

            <div class="nav-footer">
                <button class="nav-btn" onclick="goToPage(5)"><i class="fa-solid fa-arrow-left"></i> Anterior</button>
                <button class="nav-btn primary" onclick="goToPage(7)">Siguiente <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- PÁGINA 7: Resumen -->
        <div class="book-page" id="page-7">
            <h2>Capítulo 7: Manos a la Obra (Resumen)</h2>
            <p>El cambio comienza hoy. La comunicación es el puente hacia la armonía. Aquí tienes un resumen de tu trabajo:</p>
            
            <div class="interactive-box" style="background: #f7fafc;">
                <h3><i class="fa-solid fa-file-contract"></i> Recapitulación del Plan</h3>
                <p><strong>Meta Inicial:</strong> <span id="sum-intencion" style="color: var(--primary); font-weight: bold;">(Cargando...)</span></p>
                <p><strong>Virtudes Clave:</strong> <span id="sum-virtudes">(Cargando...)</span></p>
                <p><strong>Líneas Rojas:</strong> <span id="sum-lineas">(Cargando...)</span></p>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <label>Compromiso Personal:</label>
                <input type="text" id="p7-compromiso" placeholder="Me comprometo a aplicar el Sándwich el día...">
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <p style="font-size: 0.9em; color: #718096;">Usa el diálogo de impresión para guardar este documento como PDF con todas tus respuestas.</p>
                <button class="nav-btn primary" style="font-size: 1.2rem; margin: 0 auto;" onclick="window.print()">
                    <i class="fa-solid fa-print"></i> Guardar / Imprimir mi Plan
                </button>
            </div>

            <div class="nav-footer">
                <button class="nav-btn" onclick="goToPage(6)"><i class="fa-solid fa-arrow-left"></i> Anterior</button>
            </div>
        </div>

    </main>

    <script>
        // --- LÓGICA DE NAVEGACIÓN ---
        let currentPage = 1;
        
        function goToPage(pageNum) {
            // Guardar el estado actual antes de cambiar de página
            saveAllInputs();
            
            // Ocultar todas las páginas del libro
            document.querySelectorAll('.book-page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.chapter-btn').forEach(el => el.classList.remove('active'));
            
            // Mostrar la página actual
            document.getElementById(`page-${pageNum}`).classList.add('active');
            currentPage = pageNum;
            
            // Actualizar el botón de menú activo
            const buttons = document.querySelectorAll('.chapter-btn');
            if (buttons[pageNum-1]) buttons[pageNum-1].classList.add('active');
            
            // Si es la página de resumen, actualizar datos
            if (pageNum === 7) updateSummary();
            
            // Scroll al inicio del contenido principal
            document.querySelector('.main-content').scrollTo(0, 0);
        }

        // --- LÓGICA DE DRAG AND DROP ---
        function allowDrop(ev) {
            ev.preventDefault();
        }
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }
        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);
            
            // Asegura que solo se pueda soltar en un drop-zone o su hijo
            if (ev.target.classList.contains('drop-zone')) {
                ev.target.appendChild(draggedElement);
            } else if (ev.target.parentElement.classList.contains('drop-zone')) {
                ev.target.parentElement.appendChild(draggedElement);
            }
        }
        
        // --- LÓGICA DE INTERACTIVIDAD SIN PUNTUACIÓN ---
        
        // Multiple Choice / Selección sin Puntuación
        function selectOption(btn, feedbackId) {
            // Quitar clase selected de hermanos
            let parent = btn.parentNode;
            let options = parent.querySelectorAll('.mc-option');
            options.forEach(opt => opt.classList.remove('selected'));
            
            // Añadir al clickeado
            btn.classList.add('selected');
            
            // Mostrar feedback
            document.getElementById(feedbackId).style.display = 'block';
            
            // Guardar selección para persistencia
            localStorage.setItem('mc-p3-selected', btn.textContent);
        }
        
        // True/False Feedback
        function showFeedback(feedbackId, message) {
            const feedbackEl = document.getElementById(feedbackId);
            feedbackEl.textContent = message;
            feedbackEl.style.display = 'block';
        }


        // --- LÓGICA DE RESUMEN Y PERSISTENCIA (LocalStorage) ---
        
        function updateSummary() {
            // Resumen de inputs
            document.getElementById('sum-intencion').textContent = localStorage.getItem('p1-intencion') || "(Sin completar)";
            document.getElementById('sum-virtudes').textContent = localStorage.getItem('p2-virtudes') || "(Sin completar)";
            document.getElementById('sum-lineas').textContent = localStorage.getItem('p4-lineas') || "(Sin completar)";
            // Cargar el compromiso si ya existe
            document.getElementById('p7-compromiso').value = localStorage.getItem('p7-compromiso') || '';
        }

        function saveAllInputs() {
            // Guarda todos los inputs de texto/área
            document.querySelectorAll('textarea, input[type="text"]').forEach(input => {
                localStorage.setItem(input.id, input.value);
            });
            
            // Guarda el estado de Drag and Drop (qué items están en qué zona)
            // Se guarda el HTML interno de las zonas para preservar el estado de los elementos arrastrables.
            const zonePresente = document.getElementById('zone-presente').innerHTML;
            const zoneFortalecer = document.getElementById('zone-fortalecer').innerHTML;
            localStorage.setItem('dragDropState_presente', zonePresente);
            localStorage.setItem('dragDropState_fortalecer', zoneFortalecer);
            
            // Guarda el estado de selección única (opción en la página 3)
            const selectedMc = document.querySelector('#mc-container .selected');
            if (selectedMc) {
                 localStorage.setItem('mc-p3-selected', selectedMc.textContent);
            } else {
                 localStorage.removeItem('mc-p3-selected');
            }
        }

        function loadAllInputs() {
            // Carga todos los inputs de texto/área
            document.querySelectorAll('textarea, input[type="text"]').forEach(input => {
                const saved = localStorage.getItem(input.id);
                if (saved) input.value = saved;
            });
            
            // Carga el estado de Drag and Drop
            const savedPresente = localStorage.getItem('dragDropState_presente');
            const savedFortalecer = localStorage.getItem('dragDropState_fortalecer');
            
            // Solo carga si hay datos guardados para evitar sobrescribir la estructura inicial
            if (savedPresente && savedFortalecer) {
                document.getElementById('zone-presente').innerHTML = savedPresente;
                document.getElementById('zone-fortalecer').innerHTML = savedFortalecer;
            } else {
                // Si no hay datos, inicializa los eventos en la estructura original
                initializeDragEvents();
            }

            // Re-adjuntar eventos drag (necesario si se cargó desde LocalStorage)
            initializeDragEvents();
            
            // Cargar Multiple Choice
            const savedMC = localStorage.getItem('mc-p3-selected');
            if (savedMC) {
                document.querySelectorAll('.mc-option').forEach(btn => {
                    if (btn.textContent === savedMC) {
                        btn.classList.add('selected');
                    }
                });
            }
            
            // Asegurar que estamos en la primera página al cargar
            goToPage(1);
        }
        
        function initializeDragEvents() {
             // Re-adjuntar eventos drag a todos los elementos draggable (necesario tras cargar HTML desde LocalStorage)
            document.querySelectorAll('.draggable').forEach(el => {
                // Se asegura de que el evento dragstart se adjunte correctamente.
                el.setAttribute('draggable', 'true');
                el.addEventListener('dragstart', drag);
            });
            
            // Se asegura de que las zonas de drop estén listas
            document.getElementById('zone-presente').addEventListener('drop', drop);
            document.getElementById('zone-presente').addEventListener('dragover', allowDrop);
            document.getElementById('zone-fortalecer').addEventListener('drop', drop);
            document.getElementById('zone-fortalecer').addEventListener('dragover', allowDrop);
        }

        // Iniciar la carga de datos al cargar la ventana
        window.onload = loadAllInputs;
        
        // Adjuntar el evento de guardado antes de cerrar la página
        window.addEventListener('beforeunload', saveAllInputs);

    </script>
</body>
</html>